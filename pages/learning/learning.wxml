<!--pages/learning/learning.wxml-->
<!-- 希希数学小助手 学习对话页面模板 -->

<view class="learning-container">
  <!-- 顶部导航栏 -->
  <view class="nav-header">
    <view class="nav-left">
      <view class="back-btn" bindtap="exitLearning">
        <!-- 添加懒加载和模式设置 -->
        <image class="icon-image icon-white" src="/images/back-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      </view>
      <view class="nav-title">
        <text class="title-text">希希数学辅导</text>
      </view>
    </view>
    
    <view class="nav-right">
      <view class="help-btn" bindtap="getHint">
        <!-- 修改：帮助按钮使用问号图标，添加懒加载 -->
        <image class="icon-image icon-white" src="/images/question-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      </view>
    </view>
  </view>

  <!-- 题目展示区域 -->
  <view class="question-section card">
      <view class="question-header">
      <!-- 修改：题目图标使用问号图标，添加懒加载 -->
      <image class="question-icon" src="/images/question-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      <text class="question-label">题目内容</text>
    </view>
    
    <view class="question-content">
      <text class="question-text">{{questionText}}</text>
    </view>
    
    <view class="question-image" wx:if="{{questionImage}}" bindtap="previewImage">
      <image class="image" src="{{questionImage}}" mode="aspectFit" lazy-load="{{true}}"></image>
      <view class="image-overlay">
        <image class="zoom-icon" src="/images/album-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      </view>
    </view>
  </view>

  <!-- 对话消息区域 -->
  <view class="messages-section" id="messages-container">
    <view class="message-item {{item.type}}" wx:for="{{messages}}" wx:key="id">
      <!-- 系统消息 -->
      <view class="system-message" wx:if="{{item.type === 'system'}}">
        <view class="system-content">
          <image class="system-icon" src="/images/check-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
          <text class="system-text">{{item.content}}</text>
        </view>
      </view>
      
      <!-- AI消息 -->
      <view class="ai-message" wx:if="{{item.type === 'ai'}}">
        <view class="message-header">
          <view class="avatar ai-avatar">
            <!-- 头像不使用懒加载，因为需要立即显示 -->
            <image class="avatar-icon" src="/images/teacher.png" mode="aspectFill"></image>
          </view>
          <view class="sender-info">
            <text class="sender-name">希希老师</text>
            <text class="message-time">{{item.timestamp}}</text>
          </view>
          <view class="round-badge" wx:if="{{item.round}}">
            <text class="round-text">第{{item.round}}轮</text>
          </view>
        </view>
        <view class="message-bubble ai-bubble">
          <text class="message-text">{{item.content}}</text>
        </view>
      </view>
      
      <!-- 用户消息 -->
      <view class="user-message" wx:if="{{item.type === 'user'}}">
        <view class="message-header">
          <view class="round-badge" wx:if="{{item.round}}">
            <text class="round-text">第{{item.round}}轮</text>
          </view>
          <view class="sender-info">
            <text class="sender-name">我的回答</text>
            <text class="message-time">{{item.timestamp}}</text>
          </view>
          <view class="avatar user-avatar">
            <image class="avatar-icon" src="/images/student.png" mode="aspectFill"></image>
          </view>
        </view>
        <view class="message-bubble user-bubble" data-message-id="{{item.id}}" bindtap="showMessageActions">
          <text class="message-text" selectable="true">{{item.content}}</text>
          
          <!-- 悬浮操作按钮 - 仿ChatGPT -->
          <view class="message-actions-hover" wx:if="{{currentHoverId === item.id}}">
            <view class="action-btn-hover" bindtap="copyMessage" data-content="{{item.content}}" data-id="{{item.id}}">
              <image class="action-icon-small" src="/images/copy-icon.png" mode="aspectFit"></image>
            </view>
            <view class="action-btn-hover" bindtap="editMessage" data-id="{{item.id}}" data-content="{{item.content}}">
              <image class="action-icon-small" src="/images/edit-icon.png" mode="aspectFit"></image>
            </view>
          </view>
          
          <!-- 编辑模式按钮 -->
          <view class="edit-actions" wx:if="{{editingMessageId === item.id}}">
            <view class="edit-btn cancel" bindtap="cancelEdit">
              <text>取消</text>
            </view>
            <view class="edit-btn send" bindtap="confirmEdit" data-id="{{item.id}}">
              <text>发送</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- AI思考中状态 -->
      <view class="thinking-message" wx:if="{{isAIThinking}}">
      <view class="message-header">
        <view class="avatar ai-avatar">
          <!-- 头像不使用懒加载 -->
          <image class="avatar-icon" src="/images/teacher.png" mode="aspectFill"></image>
        </view>
        <view class="sender-info">
          <text class="sender-name">希希老师</text>
          <text class="message-time">正在思考...</text>
        </view>
      </view>
      <view class="message-bubble thinking-bubble">
        <view class="thinking-animation">
          <view class="thinking-dot"></view>
          <view class="thinking-dot"></view>
          <view class="thinking-dot"></view>
        </view>
        <text class="thinking-text">{{thinkingTexts[currentThinkingIndex]}}</text>
      </view>
    </view>
  </view>

  <!-- 输入区域 -->
  <view class="input-section" wx:if="{{!isSessionComplete}}">
    <view class="input-container">
      <view class="input-wrapper">
        <textarea 
          class="input-field"
          placeholder="{{inputPlaceholder}}"
          value="{{userInput}}"
          bindinput="onInputChange"
          maxlength="500"
          auto-height
          show-confirm-bar="{{false}}"
          cursor-spacing="20"
        ></textarea>
        <view class="input-counter">
          <text class="counter-text">{{userInput.length}}/500</text>
        </view>
      </view>
      
      <view class="send-btn {{userInput.trim() ? 'active' : ''}}" bindtap="sendAnswer">
        <!-- 修改：发送按钮使用发送图标，不使用懒加载（需要立即显示） -->
        <image class="icon-send" src="/images/send.png" mode="aspectFit"></image>
      </view>
    </view>
    
    <view class="input-tips">
      <view class="tip-item">
        <image class="tip-icon" src="/images/flash-on.png" lazy-load="{{true}}" mode="aspectFit"></image>
        <text class="tip-text">详细描述你的思考过程会获得更好的指导</text>
      </view>
    </view>
  </view>

  <!-- 会话完成状态 -->
  <view class="completion-section" wx:if="{{isSessionComplete}}">
    <view class="completion-content">
      <image class="completion-icon" src="/images/check-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      <text class="completion-title">学习完成！</text>
      <text class="completion-desc">恭喜你完成了这道题的学习，正在为你生成学习报告...</text>
      
      <view class="completion-actions">
        <button class="btn-primary" bindtap="goToResult">
          查看学习报告
        </button>
      </view>
    </view>
  </view>
</view>