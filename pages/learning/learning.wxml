<!--pages/learning/learning.wxml-->
<!-- 希希学习小助手 学习对话页面模板 -->

<view class="learning-container">
  <!-- 顶部导航栏 -->
  <view class="nav-header">
    <view class="nav-left">
      <view class="back-btn" bindtap="exitLearning">
        <!-- 添加懒加载和模式设置 -->
        <image class="icon-image icon-white" src="/images/back-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      </view>
      <view class="nav-title">
        <text class="title-text">希希学习辅导</text>
      </view>
    </view>
    
    <view class="nav-right">
      <view class="help-btn" bindtap="getHint">
        <!-- 修改：帮助按钮使用问号图标，添加懒加载 -->
        <image class="icon-image icon-white" src="/images/question-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      </view>
    </view>
  </view>

  <!-- 题目展示区域 -->
  <view class="question-section card">
      <view class="question-header">
      <!-- 修改：题目图标使用问号图标，添加懒加载 -->
      <image class="question-icon" src="/images/question-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      <text class="question-label">题目内容</text>
    </view>
    
    <view class="question-content">
      <text class="question-text">{{questionText}}</text>
    </view>
    
    <view class="question-image-container" wx:if="{{questionImage && !isHistoryMode}}" bindtap="previewImage">
      <image class="image" src="{{questionImage}}" mode="aspectFit" lazy-load="{{true}}"></image>
      <view class="image-overlay">
        <image class="zoom-icon" src="/images/album-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
      </view>
    </view>
  </view>

  <!-- 对话消息区域 -->
  <!-- 消息区域 -->
  <scroll-view 
    class="messages-container" 
    scroll-y="true" 
    scroll-into-view="{{scrollIntoView}}"
    scroll-with-animation="true"
    enhanced="true"
    show-scrollbar="false"
    id="messages-container">
    
    <!-- 系统消息 -->
    <view wx:if="{{questionText}}" class="message system-message" id="message-system">
      <view class="system-content">
        <image class="system-icon" src="/images/check-icon.png" lazy-load="{{true}}" mode="aspectFit"></image>
        <text class="system-text">{{item.content}}</text>
      </view>
    </view>
    
    <!-- 对话消息 -->
    <view wx:for="{{messages}}" wx:key="id" class="message {{item.type}}-message" id="message-{{index}}">
      <!-- AI消息 -->
      <view wx:if="{{item.type === 'ai'}}">
        <view class="message-header">
          <view class="avatar ai-avatar">
            <image class="avatar-icon" src="/images/teacher.png" mode="aspectFill"></image>
          </view>
          <view class="sender-info">
            <text class="sender-name">希希老师</text>
            <text class="message-time">{{item.timestamp}}</text>
          </view>
          <view class="round-badge" wx:if="{{item.round}}">
            <text class="round-text">第{{item.round}}轮</text>
          </view>
        </view>
        <view class="message-bubble ai-bubble">
          <text class="message-text">{{item.content}}</text>
          
          <!-- 新增：查看报告链接 -->
          <view wx:if="{{item.showReportLink}}" class="report-link-container">
            <text class="report-link" bindtap="onViewReportTap">查看学习报告</text>
          </view>
        </view>
      </view>
      
      <!-- 用户消息 -->
      <view wx:if="{{item.type === 'user'}}" class="user-message-container">
        <view class="message-header">
          <view class="sender-info">
            <text class="sender-name">我的回答</text>
            <text class="message-time">{{item.timestamp}}</text>
          </view>
          <view class="avatar user-avatar">
            <image class="avatar-icon" src="/images/student.png" mode="aspectFill"></image>
          </view>
        </view>
        <view class="message-bubble user-bubble" 
              bindlongpress="showMessageActions" 
              data-id="{{item.id}}" 
              data-content="{{item.content}}">
          <text class="message-text">{{item.content}}</text>
          
          <!-- 操作按钮 - 排列成一排 -->
          <view wx:if="{{currentActionMessageId === item.id}}" class="message-actions">
            <view class="action-btn copy-btn" 
                  bindtap="copyMessage" 
                  data-content="{{item.content}}">
              <image class="action-icon" src="/images/copy-icon.png" mode="aspectFit"></image>
              <text class="action-text">复制</text>
            </view>
            <view class="action-btn edit-btn" 
                  bindtap="editMessage" 
                  data-id="{{item.id}}" 
                  data-content="{{item.content}}">
              <image class="action-icon" src="/images/edit-icon.png" mode="aspectFit"></image>
              <text class="action-text">编辑</text>
            </view>
            <view class="action-btn resend-btn" 
                  bindtap="resendMessage" 
                  data-id="{{item.id}}" 
                  data-content="{{item.content}}">
              <image class="action-icon" src="/images/resend-icon.png" mode="aspectFit"></image>
              <text class="action-text">重发</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 遮罩层，点击隐藏操作按钮 -->
    <view wx:if="{{currentActionMessageId}}" class="action-mask" bindtap="hideMessageActions"></view>
    
    <!-- AI思考中状态 -->
    <view wx:if="{{isAIThinking}}" class="message ai-message thinking" id="message-thinking">
      <view class="message-header">
        <view class="avatar ai-avatar">
          <!-- 头像不使用懒加载 -->
          <image class="avatar-icon" src="/images/teacher.png" mode="aspectFill"></image>
        </view>
        <view class="sender-info">
          <text class="sender-name">希希老师</text>
          <text class="message-time">正在思考...</text>
        </view>
      </view>
      <view class="message-bubble thinking-bubble">
        <view class="thinking-animation">
          <view class="thinking-dot"></view>
          <view class="thinking-dot"></view>
          <view class="thinking-dot"></view>
        </view>
        <text class="thinking-text">{{thinkingTexts[currentThinkingIndex]}}</text>
      </view>
    </view>
  </scroll-view>

  <!-- 输入区域 -->
  <view class="input-section" wx:if="{{!isSessionComplete && !isReadOnly}}">
    <view class="input-container">
      <view class="input-wrapper">
        <textarea 
          class="input-field"
          placeholder="{{inputPlaceholder}}"
          value="{{userInput}}"
          bindinput="onInputChange"
          maxlength="500"
          auto-height
          show-confirm-bar="{{false}}"
          cursor-spacing="20"
          disabled="{{isReadOnly}}"
        ></textarea>
        <view class="input-counter">
          <text class="counter-text">{{userInput.length}}/500</text>
        </view>
      </view>
      
      <view class="send-btn {{userInput.trim() ? 'active' : ''}}" bindtap="sendAnswer">
        <image class="icon-send" src="/images/send.png" mode="aspectFit"></image>
      </view>
    </view>
    
    <view class="input-tips">
      <view class="tip-item">
        <image class="tip-icon" src="/images/flash-on.png" lazy-load="{{true}}" mode="aspectFit"></image>
        <text class="tip-text">详细描述你的思考过程会获得更好的指导</text>
      </view>
    </view>
  </view>

  <!-- 只读模式提示 -->
  <view class="readonly-notice" wx:if="{{isReadOnly}}">
    <view class="notice-content">
      <image class="notice-icon" src="/images/check-icon.png" mode="aspectFit"></image>
      <text class="notice-text">该学习记录已完成，正在查看历史对话</text>
    </view>
  </view>
</view>